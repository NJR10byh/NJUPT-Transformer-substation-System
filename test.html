<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <script src="js/jquery-3.1.1.js"></script>
  <script src="js/adapter.js"></script>
  <script src="js/platform.js"></script>
  <script src="js/h5splayer.js"></script>
  <script src="js/h5splayerhelper.js"></script>
  <link rel="stylesheet" type="text/css" href="css/h5splayer.css" />
  <link rel="stylesheet" type="text/css" href="css/test.css" />
</head>

<body>
  <div id="app">
    <div class="top">
      <div class="histroySearch">
        <button id="AutoFix">自动校准</button>
      </div>
      <div class="methods_AreaChoose">
        <div class="select_item clearfix left">
          <div class="select_module_con left">
            <div class="select_result">
              <span>选择区域</span>
              <div class="triangle"></div>
            </div>
            <ul>
              <li>平面不规则区域</li>
              <li>高程区域</li>
              <li>平面区域二</li>
            </ul>
          </div>
        </div>
        <input type="number" placeholder="请输入高程越界区域半径" id="inputradius"></input>
        <button id="ConfirmRadius">确认半径</button>
      </div>
      <div class="About_Warning">
        <button id="BeginShowLine">开始画线</button>
        <button id="EndShowLine">停止画线</button>
        <!-- <button id="openbtn">打开警报</button>
        <button id="closebtn">关闭警报</button> -->
      </div>
    </div>
  </div>
  <div class="camera1" id="camera1">
    <video id="video1" class="h5video" style="width:480px; height:640px; object-fit: fill"></video>
  </div>
  <script type="module">
    import * as THREE from "./lib/build/three.module.js";
    import { GUI } from "./lib/examples/jsm/libs/dat.gui.module.js";

    import { OrbitControls } from "./lib/examples/jsm/controls/OrbitControls.js";
    // import { MTLLoader } from "./lib/examples/jsm/loaders/MTLLoader.js";
    // import { OBJLoader } from "./lib/examples/jsm/loaders/OBJLoader.js";
    import { FBXLoader } from "./lib/examples/jsm/loaders/FBXLoader.js";
    import { EffectComposer } from "./lib/examples/jsm/postprocessing/EffectComposer.js";
    import { RenderPass } from "./lib/examples/jsm/postprocessing/RenderPass.js";
    import { ShaderPass } from "./lib/examples/jsm/postprocessing/ShaderPass.js";
    import { OutlinePass } from "./lib/examples/jsm/postprocessing/OutlinePass.js";
    import { FXAAShader } from "./lib/examples/jsm/shaders/FXAAShader.js";

    var nowarning = false; // 是否报警
    var ifshowline = false; // 是否画线
    var darwlineTimer = null;// 画线定时器
    var timer = null;// 越界检测定时器
    var SkyRadius = 26;// 高程半径
    var shishipath = [];
    var audio1 = new Audio("./sources/level1.mp3"); // 加载音频
    var audio2 = new Audio("./sources/level2.mp3"); // 加载音频

    //加入定时器
    var i = 0;

    //先生成场景
    var scene = new THREE.Scene();
    scene.background = new THREE.Color(0x999999);

    //场景参数变量
    var renderer, camera, gui, light_1, light_2, light_3;
    var mtlloader, objloader, fbxloader, gltfloader;
    var controls;

    var linearea;
    var mouse = new THREE.Vector2();
    var selectedObjects = [];
    var raycaster = new THREE.Raycaster();

    //渲染通道变量
    var composer;
    var renderPass, outlinePass, effectFXAA;

    function init() {
      //初始化渲染器
      renderer = new THREE.WebGLRenderer({
        antialias: true,
      });
      renderer.setSize(window.innerWidth, window.innerHeight);
      //渲染器阴影效果
      renderer.setClearColor(0xffffff);
      document.body.appendChild(renderer.domElement);

      //初始化相机
      camera = new THREE.PerspectiveCamera(
        45,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );
      camera.up.set(0, 0, 1);
      camera.position.set(0, 40, 75);
      camera.lookAt(new THREE.Vector3(0, 0, 0));

      //初始化光源
      light_1 = new THREE.DirectionalLight(0xffffff);
      light_2 = new THREE.DirectionalLight(0xffffff);
      light_3 = new THREE.DirectionalLight(0xffffff);
      light_1.position.set(0.5, -1.0, 0.5).normalize();
      light_2.position.set(0.5, 1.0, 0.5).normalize();
      light_3.position.set(-1.5, 1.0, 0.5).normalize();
      scene.add(light_1);
      scene.add(light_2);
      scene.add(light_3);

      //初始化模型
      //添加辅助坐标
      // var helper = new THREE.AxesHelper(50);
      // scene.add(helper);
      // mtlloader = new MTLLoader();
      // objloader = new OBJLoader();
      fbxloader = new FBXLoader();

      // obj+mtl
      // // mtlloader.load("./models/okk6.mtl", function (mtl) {
      //   mtlloader.load("./4_29/mnbdz.mtl", function (mtl) {
      //   mtl.preload();
      //   objloader.setMaterials(mtl);

      //   // var mat = mtl.materials;
      //   // for (var key in mat) {
      //   //   console.log(key);
      //   //   mat[key].transparent = true; // 类似如此修改材质属性即可
      //   // }
      //   // objloader.load("./models/okk6.obj", function (obj) {
      //     objloader.load("./4_29/mnbdz.obj", function (obj) {
      //     obj.scale.set(3, 3, 3);
      //     // 学校模型okk6
      //     obj.rotateZ(0);
      //     obj.position.x = -7.1;
      //     obj.position.y = -82;
      //     obj.position.z = 56;

      //     // 4_29
      //     // obj.rotateZ(0);
      //     // obj.position.x = 0;
      //     // obj.position.y = 0;
      //     // obj.position.z = -100;

      //     scene.add(obj);
      //   });
      // });

      // 场景fbx
      fbxloader.load('./6_9/bdz/bdz.fbx', function (object) {
        object.traverse(function (child) {
          if (child.isMesh) {
            child.castShadow = true;
            child.receiveShadow = true;
          }
        });
        object.scale.set(3, 3, 3);
        object.rotateX(Math.PI / 2);
        object.position.x = -187;
        object.position.y = 30;
        object.position.z = -142;
        scene.add(object);
      });

      //初始化用户交互插件
      controls = new OrbitControls(camera, renderer.domElement);
      // 使动画循环使用时阻尼或自转 意思是否有惯性
      controls.enableDamping = false;
      //动态阻尼系数 就是鼠标拖拽旋转灵敏度
      //controls.dampingFactor = 0.25;
      // 是否可以按键控制
      controls.enableKeys = false;
      //是否可以缩放
      controls.enableZoom = true;
      //是否自动旋转
      controls.autoRotate = false;
      //设置相机距离原点的最近距离
      controls.minDistance = 1;
      //设置相机距离原点的最远距离
      controls.maxDistance = 1000;
      //是否开启右键拖拽
      controls.enablePan = true;
      window.addEventListener("resize", onWindowResize, false);

    }

    var latestlat, latestlng, latesthigh;// 原点经纬度


    var AutoFixbtn = document.getElementById("AutoFix");
    AutoFixbtn.onclick = function autofix() {
      $.ajax({
        type: "GET",
        url: "http://124.70.106.8:8080/location/latest/",
        success: function (res) {
          console.log(res.data[res.data.length - 1].fields.lat);
          console.log(res.data[res.data.length - 1].fields.lng);
          console.log(res.data[res.data.length - 1].fields.high);
          latestlat = res.data[res.data.length - 1].fields.lat;
          latestlng = res.data[res.data.length - 1].fields.lng;
          latesthigh = res.data[res.data.length - 1].fields.high;
        },
        error: function (res) {
          console.log(res);
        },
      });
    }

    // 初始化模型
    var cube, cube1, cube2, testcube, worker_part1, worker_part2, camera_module1, camera_module2, camera_module3, camera_stick1, camera_stick2, camera_stick3, posttime, mindistance;
    mindistance = 1.5;// 距离围栏最小报警距离

    function initCube() {
      var geometryOrign = new THREE.BoxGeometry(1, 1, 1);
      var materialOrign = new THREE.MeshBasicMaterial({
        color: "white",
      });
      var geometrytest = new THREE.BoxGeometry(0.5, 0.5, 0.5);
      var materialtest = new THREE.MeshBasicMaterial({
        color: "white",
      });

      cube = new THREE.Mesh(geometrytest, materialtest);// 原点
      testcube = new THREE.Mesh(geometrytest, materialtest);// 原点
      // scene.add(cube);
      // scene.add(testcube);

      /* 模拟人物(球+圆锥) */
      // 球
      let worker_part1_ball = new THREE.SphereGeometry(0.3, 100, 100);
      worker_part1 = new THREE.Mesh(
        worker_part1_ball,
        new THREE.MeshBasicMaterial({
          color: 0x00FF00,
          side: THREE.DoubleSide,
        })
      );
      // 圆锥
      let worker_part2_zhui = new THREE.CylinderGeometry(0, 0.3, 0.5, 100, 100);
      worker_part2 = new THREE.Mesh(
        worker_part2_zhui,
        new THREE.MeshBasicMaterial({
          color: 0x00FF00,
          side: THREE.DoubleSide,
        })
      );
      worker_part2.position.z -= 0.3;
      worker_part2.rotation.x = -Math.PI / 2;
      scene.add(worker_part1);
      scene.add(worker_part2);

      /* 创建摄像头模型 */
      var shape1 = new THREE.Shape();
      /**四条直线绘制一个矩形轮廓*/
      shape1.moveTo(0, 0);//起点
      shape1.lineTo(0, 0.5);//第2点
      shape1.lineTo(0.5, 0.5);//第3点
      shape1.lineTo(0.5, 0);//第4点
      shape1.lineTo(0, 0);//第5点
      var shape2 = new THREE.Shape();
      /**四条直线绘制一个矩形轮廓*/
      shape2.moveTo(0, 0);//起点
      shape2.lineTo(0, 0.1);//第2点
      shape2.lineTo(0.1, 0.1);//第3点
      shape2.lineTo(0.1, 0);//第4点
      shape2.lineTo(0, 0);//第5点
      /**创建轮廓的扫描轨迹(3D样条曲线)*/
      var curve1_1 = new THREE.CatmullRomCurve3([
        new THREE.Vector3(5, -34.3, 11),
        new THREE.Vector3(5, -32.3, 10)
      ]);
      var curve1_2 = new THREE.CatmullRomCurve3([
        new THREE.Vector3(-74, -53, 11),
        new THREE.Vector3(-74, -51, 10),
      ]);
      var curve1_3 = new THREE.CatmullRomCurve3([
        new THREE.Vector3(-44.5, 32, 9),
        new THREE.Vector3(-44.5, 30, 8)
      ]);
      var curve2_1 = new THREE.CatmullRomCurve3([
        new THREE.Vector3(5, -34.7, 9),
        new THREE.Vector3(5, -33.3, 10.5)
      ]);
      var curve2_2 = new THREE.CatmullRomCurve3([
        new THREE.Vector3(-74, -53.4, 9),
        new THREE.Vector3(-74, -52, 10.5)
      ]);
      var curve2_3 = new THREE.CatmullRomCurve3([
        new THREE.Vector3(-44.5, 32.4, 7),
        new THREE.Vector3(-44.5, 31, 8.5)
      ]);
      // 摄像头
      var geometry1_1 = new THREE.ExtrudeGeometry(//拉伸造型
        shape1,//二维轮廓
        //拉伸参数
        {
          bevelEnabled: false,//无倒角
          extrudePath: curve1_1,//选择扫描轨迹
          steps: 50//扫描方向细分数
        }
      );
      var geometry1_2 = new THREE.ExtrudeGeometry(//拉伸造型
        shape1,//二维轮廓
        //拉伸参数
        {
          bevelEnabled: false,//无倒角
          extrudePath: curve1_2,//选择扫描轨迹
          steps: 50//扫描方向细分数
        }
      );
      var geometry1_3 = new THREE.ExtrudeGeometry(//拉伸造型
        shape1,//二维轮廓
        //拉伸参数
        {
          bevelEnabled: false,//无倒角
          extrudePath: curve1_3,//选择扫描轨迹
          steps: 50//扫描方向细分数
        }
      );
      // 支架
      var geometry2_1 = new THREE.ExtrudeGeometry(//拉伸造型
        shape2,//二维轮廓
        //拉伸参数
        {
          bevelEnabled: false,//无倒角
          extrudePath: curve2_1,//选择扫描轨迹
          steps: 50//扫描方向细分数
        }
      );
      var geometry2_2 = new THREE.ExtrudeGeometry(//拉伸造型
        shape2,//二维轮廓
        //拉伸参数
        {
          bevelEnabled: false,//无倒角
          extrudePath: curve2_2,//选择扫描轨迹
          steps: 50//扫描方向细分数
        }
      );
      var geometry2_3 = new THREE.ExtrudeGeometry(//拉伸造型
        shape2,//二维轮廓
        //拉伸参数
        {
          bevelEnabled: false,//无倒角
          extrudePath: curve2_3,//选择扫描轨迹
          steps: 50//扫描方向细分数
        }
      );
      var material1_1 = new THREE.MeshBasicMaterial({ color: 0xffffff });
      var material2_1 = new THREE.MeshBasicMaterial({ color: 0xffffff });
      var material1_2 = new THREE.MeshBasicMaterial({ color: 0xffffff });
      var material2_2 = new THREE.MeshBasicMaterial({ color: 0xffffff });
      var material1_3 = new THREE.MeshBasicMaterial({ color: 0xffffff });
      var material2_3 = new THREE.MeshBasicMaterial({ color: 0xffffff });
      camera_module1 = new THREE.Mesh(geometry1_1, material1_1);
      camera_module2 = new THREE.Mesh(geometry1_2, material1_2);
      camera_module3 = new THREE.Mesh(geometry1_3, material1_3);
      camera_stick1 = new THREE.Mesh(geometry2_1, material2_1);
      camera_stick2 = new THREE.Mesh(geometry2_2, material2_2);
      camera_stick3 = new THREE.Mesh(geometry2_3, material2_3);
      scene.add(camera_module1);
      scene.add(camera_module2);
      scene.add(camera_module3);
      scene.add(camera_stick1);
      scene.add(camera_stick2);
      scene.add(camera_stick3);
    }

    initCube();// 初始化模型函数
    function SafeHat() {
      // 如果有人员未带安全帽，将该区域的摄像头变红
      // console.log(camera_module1.material.color);
      // 摄像头默认是白色
      camera_module1.material.color.setHex(0xffffff);
      camera_stick1.material.color.setHex(0xffffff);
      camera_module2.material.color.setHex(0xffffff);
      camera_stick2.material.color.setHex(0xffffff);
      camera_module3.material.color.setHex(0xffffff);
      camera_stick3.material.color.setHex(0xffffff);
      $.ajax({
        type: "GET",
        url: "http://124.70.106.8:8080/device/check/",
        success: function (res) {
          for (let i = 0; i < res.data.length; i++) {
            if (res.data[i].fields.rtmpname == "live1") {
              camera_module1.material.color.setHex(0xff0000);
              camera_stick1.material.color.setHex(0xff0000);
            }
            if (res.data[i].fields.rtmpname == "live2") {
              camera_module2.material.color.setHex(0xff0000);
              camera_stick2.material.color.setHex(0xff0000);
            }
            if (res.data[i].fields.rtmpname == "live3") {
              camera_module3.material.color.setHex(0xff0000);
              camera_stick3.material.color.setHex(0xff0000);
            }
          }
        },
        error: function (res) {
          console.log(res);
        },
      });
    }

    setInterval(() => {
      SafeHat();
    }, 1000);

    // 经纬度同坐标转换
    function X_position(lng) {
      var x = (lng - latestlng) * (294117.647);
      return x;
    }
    function Y_position(lat) {
      var y = (lat - latestlat) * (327272.727);
      return y;
    }
    function Z_position(high) {
      var z = (high - latesthigh) * 2.2;
      return z;
    }

    // 显示两点之间连线
    function ShowLine(x_1, x_2, y_1, y_2, high_1, high_2) {
      console.log(x_1, x_2, y_1, y_2, high_1, high_2);
      var geometry = new THREE.Geometry();
      var meterial = new THREE.LineBasicMaterial({
        color: 0xff0000,
      });
      geometry.vertices.push(new THREE.Vector3(x_1, y_1, high_1));
      geometry.vertices.push(new THREE.Vector3(x_2, y_2, high_2));
      var line = new THREE.Line(geometry, meterial);
      scene.add(line);
    }

    // 人员位置
    function worker_position(lng, lat, high) {
      worker_part1.position.x =
        X_position(lng);
      worker_part1.position.y =
        Y_position(lat);
      worker_part1.position.z =
        Z_position(high);
      worker_part2.position.x =
        X_position(lng);
      worker_part2.position.y =
        Y_position(lat);
      worker_part2.position.z =
        Z_position(high) - 0.3;
      console.log(worker_part1.position.x);
      console.log(worker_part1.position.y);
      console.log(worker_part1.position.z);
    }

    /* 实时路径 */
    var aaa = "1";

    // 越界检测
    function check_dangerous(test, area2, area3, area4, area5, mode) {
      posttime = 6;
      console.log(area3);
      timer = setInterval(function () {
        $.ajax({
          type: "GET",
          url: "http://124.70.106.8:8080/location/latest/",
          success: function (res) {
            console.log(res.data[res.data.length - 1].fields.lat, latestlat);
            console.log(res.data[res.data.length - 1].fields.lng, latestlng);
            console.log(res.data[res.data.length - 1].fields.high, latesthigh);
            worker_position(res.data[res.data.length - 1].fields.lng, res.data[res.data.length - 1].fields.lat, res.data[res.data.length - 1].fields.high);
            console.log(mode == "ground");
            switch (mode) {
              case "ground":
                // 平面越界警报
                PlaneCheck(test, [X_position(res.data[res.data.length - 1].fields.lng), Y_position(res.data[res.data.length - 1].fields.lat), Z_position(res.data[res.data.length - 1].fields.high)]);
                if (ifshowline) {
                  let newpath = {
                    x: X_position(res.data[res.data.length - 1].fields.lng),
                    y: Y_position(res.data[res.data.length - 1].fields.lat),
                    z: 0,
                  };
                  shishipath.push(newpath);
                  if (shishipath.length == 2) {
                    ShowLine(
                      shishipath[0].x,
                      shishipath[1].x,
                      shishipath[0].y,
                      shishipath[1].y,
                      shishipath[0].z,
                      shishipath[1].z
                    );
                    shishipath.shift();
                  }
                }
                break;
              case "sky":
                // 高程越界警报
                if (SkyCheck(area2, [X_position(res.data[res.data.length - 1].fields.lng), Y_position(res.data[res.data.length - 1].fields.lat), Z_position(res.data[res.data.length - 1].fields.high)])) {
                  // console.log("进入危险区域了！！");
                  worker_part1.material.color.setHex(0xff0000);
                  worker_part2.material.color.setHex(0xff0000);
                  if (posttime == 6) {
                    posttime = 1;
                    if (!nowarning) {
                      audio1.pause();
                      audio2.pause();
                      audio1.load();
                      audio2.load();
                      audio2.play();
                    }
                    // $.ajax({
                    //   type: "POST",
                    //   url: "http://124.70.106.8:8080/device/alarm/",
                    //   data: {
                    //     workername: "name",
                    //     lng: res.data[res.data.length - 1].fields.lng,
                    //     lat: res.data[res.data.length - 1].fields.lat,
                    //     high: res.data[res.data.length - 1].fields.high
                    //   },
                    //   success: function (res) {
                    //     console.log(res)
                    //   }
                    // })
                  } else {
                    audio1.pause();
                    audio2.pause();
                    audio1.load();
                    audio2.load();
                    posttime++;
                  }
                } else {
                  // console.log("未进入危险区域");
                  audio1.pause();
                  audio2.pause();
                  audio1.load();
                  audio2.load();
                  worker_part1.material.color.setHex(0x00FF00);
                  worker_part2.material.color.setHex(0x00FF00);
                }
                break;
              case "pole":
                // 电线杆靠近检测
                let x1 = X_position(res.data[res.data.length - 1].fields.lng);
                let y1 = Y_position(res.data[res.data.length - 1].fields.lat);
                let x2 = area3[0][0];
                let y2 = area3[0][1];
                let dx = x1 - x2;
                let dy = y1 - y2;
                if (Math.sqrt(Math.pow(dx, 2) + Math.pow(dy, 2)) < 1.5) {
                  // console.log("进入危险区域了！！");
                  worker_part1.material.color.setHex(0xff0000);
                  worker_part2.material.color.setHex(0xff0000);
                  if (posttime == 6) {
                    posttime = 1;
                    if (!nowarning) {
                      audio1.pause();
                      audio2.pause();
                      audio1.load();
                      audio2.load();
                      audio2.play();
                    }
                    // $.ajax({
                    //   type: "POST",
                    //   url: "http://124.70.106.8:8080/device/alarm/",
                    //   data: {
                    //     workername: "name",
                    //     lng: res.data[res.data.length - 1].fields.lng,
                    //     lat: res.data[res.data.length - 1].fields.lat,
                    //     high: res.data[res.data.length - 1].fields.high
                    //   },
                    //   success: function (res) {
                    //     console.log(res)
                    //   }
                    // })
                  } else {
                    audio1.pause();
                    audio2.pause();
                    audio1.load();
                    audio2.load();
                    posttime++;
                  }
                } else {
                  // console.log("未进入危险区域");
                  audio1.pause();
                  audio2.pause();
                  audio1.load();
                  audio2.load();
                  worker_part1.material.color.setHex(0x00FF00);
                  worker_part2.material.color.setHex(0x00FF00);
                }
                break;
              case "all":
                switch (true) {
                  case Z_position(res.data[res.data.length - 1].fields.high, latesthigh) < 4:
                    // 平面越界警报
                    PlaneCheck(test, [X_position(res.data[res.data.length - 1].fields.lng), Y_position(res.data[res.data.length - 1].fields.lat), Z_position(res.data[res.data.length - 1].fields.high)]);
                    break;
                  case Z_position(res.data[res.data.length - 1].fields.high, latesthigh) >= 4:
                    // 高程越界警报
                    if (SkyCheck(area2, [X_position(res.data[res.data.length - 1].fields.lng), Y_position(res.data[res.data.length - 1].fields.lat), Z_position(res.data[res.data.length - 1].fields.high)])) {
                      // console.log("进入危险区域了！！");
                      worker_part1.material.color.setHex(0xff0000);
                      worker_part2.material.color.setHex(0xff0000);
                      if (posttime == 6) {
                        posttime = 1;
                        if (!nowarning) {
                          audio1.pause();
                          audio2.pause();
                          audio1.load();
                          audio2.load();
                          audio2.play();
                        }
                        // $.ajax({
                        //   type: "POST",
                        //   url: "http://124.70.106.8:8080/device/alarm/",
                        //   data: {
                        //     workername: "name",
                        //     lng: res.data[res.data.length - 1].fields.lng,
                        //     lat: res.data[res.data.length - 1].fields.lat,
                        //     high: res.data[res.data.length - 1].fields.high
                        //   },
                        //   success: function (res) {
                        //     console.log(res)
                        //   }
                        // })
                      } else {
                        audio1.pause();
                        audio2.pause();
                        audio1.load();
                        audio2.load();
                        posttime++;
                      }
                    } else {
                      // console.log("未进入危险区域");
                      audio1.pause();
                      audio2.pause();
                      audio1.load();
                      audio2.load();
                      worker_part1.material.color.setHex(0x00FF00);
                      worker_part2.material.color.setHex(0x00FF00);
                    }
                    break;
                  case Math.abs(X_position(res.data[res.data.length - 1].fields.lng) - 11.8) <= 3 && Math.abs(Y_position(res.data[res.data.length - 1].fields.lat) - 0.5) <= 3:
                    // 电线杆靠近检测
                    let x1 = X_position(res.data[res.data.length - 1].fields.lng);
                    let y1 = Y_position(res.data[res.data.length - 1].fields.lat);
                    let x2 = area3[0][0];
                    let y2 = area3[0][1];
                    let dx = x1 - x2;
                    let dy = y1 - y2;
                    if (Math.sqrt(Math.pow(dx, 2) + Math.pow(dy, 2)) < 1.5) {
                      // console.log("进入危险区域了！！");
                      worker_part1.material.color.setHex(0xff0000);
                      worker_part2.material.color.setHex(0xff0000);
                      if (posttime == 6) {
                        posttime = 1;
                        if (!nowarning) {
                          audio1.pause();
                          audio2.pause();
                          audio1.load();
                          audio2.load();
                          audio2.play();
                        }
                        // $.ajax({
                        //   type: "POST",
                        //   url: "http://124.70.106.8:8080/device/alarm/",
                        //   data: {
                        //     workername: "name",
                        //     lng: res.data[res.data.length - 1].fields.lng,
                        //     lat: res.data[res.data.length - 1].fields.lat,
                        //     high: res.data[res.data.length - 1].fields.high
                        //   },
                        //   success: function (res) {
                        //     console.log(res)
                        //   }
                        // })
                      } else {
                        audio1.pause();
                        audio2.pause();
                        audio1.load();
                        audio2.load();
                        posttime++;
                      }
                    } else {
                      // console.log("未进入危险区域");
                      audio1.pause();
                      audio2.pause();
                      audio1.load();
                      audio2.load();
                      worker_part1.material.color.setHex(0x00FF00);
                      worker_part2.material.color.setHex(0x00FF00);
                    }
                    break;
                  default:
                    break;
                }
                break;
              case "skylow":
                // 高程越界警报
                if (SkyCheck(area5, [X_position(res.data[res.data.length - 1].fields.lng), Y_position(res.data[res.data.length - 1].fields.lat), Z_position(res.data[res.data.length - 1].fields.high)])) {
                  // console.log("进入危险区域了！！");
                  worker_part1.material.color.setHex(0xff0000);
                  worker_part2.material.color.setHex(0xff0000);
                  if (posttime == 6) {
                    posttime = 1;
                    if (!nowarning) {
                      audio1.pause();
                      audio2.pause();
                      audio1.load();
                      audio2.load();
                      audio2.play();
                    }
                    // $.ajax({
                    //   type: "POST",
                    //   url: "http://124.70.106.8:8080/device/alarm/",
                    //   data: {
                    //     workername: "name",
                    //     lng: res.data[res.data.length - 1].fields.lng,
                    //     lat: res.data[res.data.length - 1].fields.lat,
                    //     high: res.data[res.data.length - 1].fields.high
                    //   },
                    //   success: function (res) {
                    //     console.log(res)
                    //   }
                    // })
                  } else {
                    audio1.pause();
                    audio2.pause();
                    audio1.load();
                    audio2.load();
                    posttime++;
                  }
                } else {
                  // console.log("未进入危险区域");
                  audio1.pause();
                  audio2.pause();
                  audio1.load();
                  audio2.load();
                  worker_part1.material.color.setHex(0x00FF00);
                  worker_part2.material.color.setHex(0x00FF00);
                }
                break;
              default:
                break;
            }
          },
          error: function (res) {
            console.log(res);
          },
        });
      }, 500);
    }


    //声明一个时钟对象
    // var clock = new THREE.Clock();
    document.addEventListener('mouseup', onMouseUp);

    function render() {
      renderer.render(scene, camera);
    }

    var objects = [];

    /* 查看视频流 */
    function onMouseUp(event) {
      var rayCaster = getRay(event);
      var intersects1 = rayCaster.intersectObjects([camera_module1]);//参数需为数组
      var intersects2 = rayCaster.intersectObjects([camera_module2]);//参数需为数组
      var intersects3 = rayCaster.intersectObjects([camera_module3]);//参数需为数组
      //左键点击并且点击的是物体时
      if (event.button === 0 && intersects1[0]) {
        let selectObj = intersects1[0].object;//储存当前点击的对象
        divRender1();
      } else if (event.button === 0 && intersects2[0]) {
        let selectObj = intersects2[0].object;//储存当前点击的对象
        divRender2();
      } else if (event.button === 0 && intersects3[0]) {
        let selectObj = intersects3[0].object;//储存当前点击的对象
        divRender3();
      } else if (event.button === 2 || event.button === 1) {
        return;
      } else {
        let div = document.getElementById('camera1');
        div.style.display = "none";
      }
    }
    //根据鼠标点击的点和相机建立一条射线
    function getRay(event) {
      event.preventDefault();
      var mouse = new THREE.Vector2();
      var rayCaster = new THREE.Raycaster();
      var rect = renderer.domElement.getBoundingClientRect();
      mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
      mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
      rayCaster.setFromCamera(mouse, camera);
      return rayCaster;
    }
    // div位置变换和赋值
    function divRender1() {
      console.log(v1);
      console.log("1");
      //计算三维坐标对应的屏幕坐标
      var right = 0;
      var bottom = 0;
      //设置div屏幕位置
      let div = document.getElementById('camera1');
      div.style.display = "inline";
      div.style.right = right + 'px';
      div.style.bottom = bottom + 'px';
      if (v1 != undefined) {
        v1.disconnect();
      }
      $(function () {
        var conf1 = {
          videoid: 'video1',
          protocol: 'http:', //'http:' or 'https:'
          host: 'localhost:8082', //'localhost:8080'
          rootpath: '/', // '/' or window.location.pathname
          token: 'token1',
          hlsver: 'v1', //v1 is for ts, v2 is for fmp4
          session: 'c1782caf-b670-42d8-ba90-2244d0b0ee83' //session got from login
        };
        v1 = H5sPlayerCreate(conf1);
        v1.connect();
      });
    }
    var v1;
    function divRender2() {
      //计算三维坐标对应的屏幕坐标
      var right = 0;
      var bottom = 0;
      //设置div屏幕位置
      let div = document.getElementById('camera1');
      div.style.display = "inline";
      div.style.right = right + 'px';
      div.style.bottom = bottom + 'px';
      if (v1 != undefined) {
        v1.disconnect();
      }
      $(function () {
        var conf2 = {
          videoid: 'video1',
          protocol: 'http:', //'http:' or 'https:'
          host: 'localhost:8082', //'localhost:8080'
          rootpath: '/', // '/' or window.location.pathname
          token: 'token2',
          hlsver: 'v1', //v1 is for ts, v2 is for fmp4
          session: 'c1782caf-b670-42d8-ba90-2244d0b0ee83' //session got from login
        };
        v1 = H5sPlayerCreate(conf2);
        v1.connect();
      });
    }
    function divRender3() {
      console.log("3");
      //计算三维坐标对应的屏幕坐标
      var right = 0;
      var bottom = 0;
      //设置div屏幕位置
      let div = document.getElementById('camera1');
      div.style.display = "inline";
      div.style.right = right + 'px';
      div.style.bottom = bottom + 'px';
      if (v1 != undefined) {
        v1.disconnect();
      }
      $(function () {
        var conf3 = {
          videoid: 'video1',
          protocol: 'http:', //'http:' or 'https:'
          host: 'localhost:8082', //'localhost:8080'
          rootpath: '/', // '/' or window.location.pathname
          token: 'token3',
          hlsver: 'v1', //v1 is for ts, v2 is for fmp4
          session: 'c1782caf-b670-42d8-ba90-2244d0b0ee83' //session got from login
        };
        v1 = H5sPlayerCreate(conf3);
        v1.connect();
      });
    }

    // 增加墙体
    function addWall(position) {
      // 三维围栏（BYH）
      for (let i = 0; i < position.length - 1; i++) {
        // 计算长度
        let dx = Math.abs(position[i][0] - position[i + 1][0]);
        let dy = Math.abs(position[i][1] - position[i + 1][1]);
        let width = Math.sqrt(Math.pow(dx, 2) + Math.pow(dy, 2));
        let geometryBox = new THREE.BoxGeometry(width, 0.5, 14);
        let lineSegments = new THREE.Mesh(
          geometryBox,
          new THREE.MeshBasicMaterial({
            color: "yellow",
            side: THREE.DoubleSide,
            transparent: true,
            opacity: 0.2,
          })
        );
        // lineSegments.computeLineDistances();
        // 增加一个旋转角度
        // 求角度
        let deg = Math.atan(
          (position[i][1] - position[i + 1][1]) /
          (position[i][0] - position[i + 1][0])
        );
        lineSegments.rotation.z = deg;

        objects.push(lineSegments);
        lineSegments.position.x = (position[i][0] + position[i + 1][0]) / 2;
        lineSegments.position.y = (position[i][1] + position[i + 1][1]) / 2;
        lineSegments.position.z = 0;
        scene.add(lineSegments);
      }
    }

    //添加圆柱体
    function addSkycheck(start, end, radius) {
      var cylinder = createCylinderByTwoPoints(start, end, radius);
      scene.add(cylinder);

      //画一条直线方便观察
      var geometry3 = new THREE.Geometry();
      geometry3.vertices.push(start);
      geometry3.vertices.push(end);
      var line = new THREE.Line(
        geometry3,
        new THREE.LineBasicMaterial({
          color: "black",
        }),
        THREE.LineSegments
      );
      scene.add(line);

      // 球体
      let sphereGeometry_2_1 = new THREE.SphereGeometry(radius, 100, 100);
      let sphereGeometry_2_2 = new THREE.SphereGeometry(radius, 100, 100);
      let lineSegments_2_1 = new THREE.Mesh(
        sphereGeometry_2_1,
        new THREE.MeshBasicMaterial({
          color: "red",
          side: THREE.DoubleSide,
          transparent: true,
          opacity: 0.2,
        })
      );
      let lineSegments_2_2 = new THREE.Mesh(
        sphereGeometry_2_2,
        new THREE.MeshBasicMaterial({
          color: "red",
          side: THREE.DoubleSide,
          transparent: true,
          opacity: 0.2,
        })
      );

      objects.push(lineSegments_2_1);
      lineSegments_2_1.position.x = start.x;
      lineSegments_2_1.position.y = start.y;
      lineSegments_2_1.position.z = start.z;
      scene.add(lineSegments_2_1);
      objects.push(lineSegments_2_2);
      lineSegments_2_2.position.x = end.x;
      lineSegments_2_2.position.y = end.y;
      lineSegments_2_2.position.z = end.z;
      scene.add(lineSegments_2_2);
    }

    // 根据两点画圆柱
    function createCylinderByTwoPoints(pointX, pointY, radius) {
      var direction = new THREE.Vector3().subVectors(pointY, pointX);
      var orientation = new THREE.Matrix4();
      orientation.lookAt(pointX, pointY, new THREE.Object3D().up);
      orientation.multiply(
        new THREE.Matrix4().set(
          1,
          0,
          0,
          0,
          0,
          0,
          1,
          0,
          0,
          -1,
          0,
          0,
          0,
          0,
          0,
          1
        )
      );
      var edgeGeometry = new THREE.CylinderGeometry(
        radius,
        radius,
        direction.length(),
        100,
        100
      );
      var material = new THREE.MeshLambertMaterial({
        color: "red",
        side: THREE.DoubleSide,
        transparent: true,
        opacity: 0.2,
      });
      var edge = new THREE.Mesh(edgeGeometry, material);
      edge.applyMatrix4(orientation);
      //两个点的中心点 position based on midpoints - there may be a better solution than this
      edge.position.x = (pointY.x + pointX.x) / 2;
      edge.position.y = (pointY.y + pointX.y) / 2;
      edge.position.z = (pointY.z + pointX.z) / 2;
      return edge;
    }

    // 判断平面区域越界
    function PlaneCheck(safearea, workerlocation) {
      let minx = safearea[0][0];
      let maxx = safearea[0][0];
      let miny = safearea[0][1];
      let maxy = safearea[0][1];
      for (let i = 1; i < safearea.length; i++) {
        if (safearea[i][0] < minx) {
          minx = safearea[i][0];
        }
        if (safearea[i][0] > maxx) {
          maxx = safearea[i][0];
        }
        if (safearea[i][1] < miny) {
          miny = safearea[i][1];
        }
        if (safearea[i][1] > maxy) {
          maxy = safearea[i][1];
        }
      }
      if (
        workerlocation[0] >= minx &&
        workerlocation[0] <= maxx &&
        workerlocation[1] >= miny &&
        workerlocation[1] <= maxy
      ) {
        var c = false;
        var distanceArr = [];
        for (let j = 0; j < safearea.length - 1; j++) {
          let arr = [safearea[j], safearea[j + 1]];
          let dis = CheckDistance(arr, workerlocation, safearea);
          distanceArr.push(dis);
          if (
            ((safearea[j][1] <= workerlocation[1] &&
              workerlocation[1] < safearea[j + 1][1]) ||
              (safearea[j + 1][1] <= workerlocation[1] &&
                workerlocation[1] < safearea[j][1])) && (
              workerlocation[0] <
              ((safearea[j + 1][0] - safearea[j][0]) *
                (workerlocation[1] - safearea[j][1])) /
              (safearea[j + 1][1] - safearea[j][1]) +
              safearea[j][0])
          ) {
            // 在安全区域内返回true
            c = !c;
          }
        }
        if (!c) {
          // 不在安全区域内
          worker_part1.material.color.setHex(0xFF0000);
          worker_part2.material.color.setHex(0xFF0000);
          // audio1.pause();
          // audio2.pause();
          // audio1.load();
          // audio2.load();
          // audio2.play();
          if (posttime == 6) {
            posttime = 1;
            if (!nowarning) {
              audio1.pause();
              audio2.pause();
              audio1.load();
              audio2.load();
              audio2.play();
            }
            // $.ajax({
            //   type: "POST",
            //   url: "http://124.70.106.8:8080/device/alarm/",
            //   data: {
            //     workername: "name",
            //     lng: res.data[res.data.length - 1].fields.lng,
            //     lat: res.data[res.data.length - 1].fields.lat,
            //     high: res.data[res.data.length - 1].fields.high
            //   },
            //   success: function (res) {
            //     console.log(res);
            //   }
            // })
          } else {
            audio1.pause();
            audio2.pause();
            audio1.load();
            audio2.load();
            posttime++;
          }
        }
        // 在安全区域内
        else {
          console.log(Math.min(...distanceArr));
          if (Math.min(...distanceArr) < mindistance) {
            console.log("靠近危险区域");
            worker_part1.material.color.setHex(0xFFD700);
            worker_part2.material.color.setHex(0xFFD700);
            audio1.pause();
            audio2.pause();
            audio1.load();
            audio2.load();
            audio1.play();
          }
          else {
            worker_part1.material.color.setHex(0x00FF00);
            worker_part2.material.color.setHex(0x00FF00);
            audio1.pause();
            audio2.pause();
            audio1.load();
            audio2.load();
          }
        }
        return c;
      }
    }

    // 判断高程区域越界
    function SkyCheck(WarinngArea, workLocation) {
      console.log(workLocation);
      // Step1: 确定投影范围
      var point1 = [];
      var point2 = [];
      var point3 = [];
      var point4 = [];
      let tan = 0;
      let sin = 0;
      let cos = 0;
      switch (true) {
        /* 情况1：投影平行于y轴 */
        case WarinngArea[0][0] == WarinngArea[1][0]:
          point1 = [WarinngArea[0][0] - 1, WarinngArea[0][1]];
          point2 = [WarinngArea[0][0] + 1, WarinngArea[0][1]];
          point3 = [WarinngArea[1][0] - 1, WarinngArea[1][1]];
          point4 = [WarinngArea[1][0] + 1, WarinngArea[1][1]];
          break;
        /* 情况2：投影平行于x轴 */
        case WarinngArea[0][1] == WarinngArea[1][1]:
          point1 = [WarinngArea[0][0], WarinngArea[0][1] + 1];
          point2 = [WarinngArea[0][0], WarinngArea[0][1] - 1];
          point3 = [WarinngArea[1][0], WarinngArea[1][1] + 1];
          point4 = [WarinngArea[1][0], WarinngArea[1][1] - 1];
          break;
        /* 情况3：与x轴夹角小于90 (tan>0) */
        case (WarinngArea[1][1] - WarinngArea[0][1]) /
          (WarinngArea[1][0] - WarinngArea[0][0]) >
          0:
          tan =
            (WarinngArea[1][1] - WarinngArea[0][1]) /
            (WarinngArea[1][0] - WarinngArea[0][0]);
          sin = Math.sin(Math.atan(tan));
          cos = Math.cos(Math.atan(tan));
          console.log(tan, sin, cos);
          point1 = [WarinngArea[0][0] - sin, WarinngArea[0][1] + cos];
          point2 = [WarinngArea[0][0] + sin, WarinngArea[0][1] - cos];
          point3 = [WarinngArea[1][0] - sin, WarinngArea[1][1] + cos];
          point4 = [WarinngArea[1][0] + sin, WarinngArea[1][1] - cos];
        /* 情况4：与x轴夹角大于90 (tan<0) */
        case (WarinngArea[1][1] - WarinngArea[0][1]) /
          (WarinngArea[1][0] - WarinngArea[0][0]) <
          0:
          tan =
            -(WarinngArea[1][1] - WarinngArea[0][1]) /
            (WarinngArea[1][0] - WarinngArea[0][0]);
          sin = Math.sin(Math.atan(tan));
          cos = Math.cos(Math.atan(tan));
          point1 = [WarinngArea[0][0] - sin, WarinngArea[0][1] - cos];
          point2 = [WarinngArea[0][0] + sin, WarinngArea[0][1] + cos];
          point3 = [WarinngArea[1][0] - sin, WarinngArea[1][1] - cos];
          point4 = [WarinngArea[1][0] + sin, WarinngArea[1][1] + cos];
        default:
          break;
      }
      // console.log(point1, point2, point3, point4);
      // Step2: 找出四个点中x和y值的 min
      // ...为es6拓展运算符
      let minx = Math.min(...[point1[0], point2[0], point3[0], point4[0]]);
      let miny = Math.min(...[point1[1], point2[1], point3[1], point4[1]]);
      let maxx = Math.max(...[point1[0], point2[0], point3[0], point4[0]]);
      let maxy = Math.max(...[point1[1], point2[1], point3[1], point4[1]]);
      if (
        workLocation[0] >= minx &&
        workLocation[0] <= maxx &&
        workLocation[1] >= miny &&
        workLocation[1] <= maxy
      ) {
        // Step3: 计算点到线的距离
        let distance = CheckDistanceSky(WarinngArea, workLocation);
        console.log(distance);
        let SkyRadiusarea = SkyRadius + 0.5;
        switch (true) {
          case distance <= SkyRadiusarea:
            return true;
            break;
          case distance > SkyRadiusarea:
            return false;
            break;
          default:
            break;
        }
      } else {
        return false;
      }
    }

    // 检测最短距离（平面区域）
    function CheckDistance(LineLocation, PointLocation, safearea) {
      // 垂足点坐标
      let FootPoint = [];

      // 两点坐标差
      let dx = LineLocation[1][0] - LineLocation[0][0];
      let dy = LineLocation[1][1] - LineLocation[0][1];

      // 墙体直线的k1，b1，还有垂直于墙体所在直线的k2，b2
      let k1 = 0;
      let k2 = 0;
      let b1 = 0;
      let b2 = 0;

      // 计算最短距离
      let dis = [];
      let Distance = 0;

      // 墙体所在直线的最小x和y
      let LineLocation_X = [LineLocation[0][0], LineLocation[1][0]];
      let LineLocation_Y = [LineLocation[0][1], LineLocation[1][1]];
      //  确保两个点不是同一个点

      // 墙体垂直于x轴
      if (dy != 0 && dx == 0) {
        FootPoint = [LineLocation[0][0], PointLocation[1]];
        if (Math.min(...LineLocation_Y) <= FootPoint[1] && Math.max(...LineLocation_Y) >= FootPoint[1]) {
          let xx = Math.abs(PointLocation[0] - FootPoint[0]);
          let yy = Math.abs(PointLocation[1] - FootPoint[1]);
          Distance = Math.sqrt(Math.pow(xx, 2) + Math.pow(yy, 2));
        } else {
          for (let i = 0; i < safearea.length - 1; i++) {
            dis.push(Math.sqrt(Math.pow(Math.abs(safearea[i][0] - PointLocation[0]), 2) + Math.pow(Math.abs(safearea[i][1] - PointLocation[1]), 2)));
          }
          Distance = Math.min(...dis);
        }
      }
      // 墙体垂直于y轴
      else if (dx != 0 && dy == 0) {
        FootPoint = [PointLocation[0], LineLocation[0][1]];
        if (Math.min(...LineLocation_X) <= FootPoint[0] && Math.max(...LineLocation_X) >= FootPoint[0]) {
          let xx = Math.abs(PointLocation[0] - FootPoint[0]);
          let yy = Math.abs(PointLocation[1] - FootPoint[1]);
          Distance = Math.sqrt(Math.pow(xx, 2) + Math.pow(yy, 2));
        } else {
          for (let i = 0; i < safearea.length - 1; i++) {
            dis.push(Math.sqrt(Math.pow(Math.abs(safearea[i][0] - PointLocation[0]), 2) + Math.pow(Math.abs(safearea[i][1] - PointLocation[1]), 2)));
          }
          Distance = Math.min(...dis);
        }
      } else if (dx != 0 && dy != 0) {
        //计算斜率
        k1 = dy / dx;
        b1 = LineLocation[0][1] - k1 * LineLocation[0][0];
        k2 = -dx / dy;
        b2 = PointLocation[1] - k2 * PointLocation[0];

        // 垂足点坐标
        FootPoint = [(b2 - b1) / (k1 - k2), k1 * (b2 - b1) / (k1 - k2) + b1];

        // console.log(FootPoint);

        // 如果垂足落在墙体所在直线上。则直接计算两点间距离，即为最短路径
        if (Math.min(...LineLocation_Y) <= FootPoint[1] && Math.max(...LineLocation_Y) >= FootPoint[1]) {
          let xx = Math.abs(PointLocation[0] - FootPoint[0]);
          let yy = Math.abs(PointLocation[1] - FootPoint[1]);
          Distance = Math.sqrt(Math.pow(xx, 2) + Math.pow(yy, 2));
        }
        // 如果垂足没有落在墙体所在直线上。则计算待测点（不是垂足点）与墙体所有坐标点的距离，取最短
        else {
          for (let i = 0; i < safearea.length - 1; i++) {
            dis.push(Math.sqrt(Math.pow(Math.abs(safearea[i][0] - PointLocation[0]), 2) + Math.pow(Math.abs(safearea[i][1] - PointLocation[1]), 2)));
          }
          Distance = Math.min(...dis);
        }
      }
      return Distance;
    }
    // 检测最短距离（高程区域）
    function CheckDistanceSky(LineLocation, PointLocation) {
      let dx = LineLocation[1][0] - LineLocation[0][0];
      let dy = LineLocation[1][1] - LineLocation[0][1];
      let dz = LineLocation[1][2] - LineLocation[0][2];
      let k = 0;
      //  确保两个点不是同一个点
      if (dx != 0 || dy != 0 || dz != 0) {
        //计算斜率
        k =
          (PointLocation[0] - LineLocation[0][0]) * dx +
          (PointLocation[1] - LineLocation[0][1]) * dy +
          (PointLocation[2] - LineLocation[0][2]) * dz;
        k = k / (Math.pow(dx, 2) + Math.pow(dy, 2) + Math.pow(dz, 2));
      }
      let FootPoint = [
        LineLocation[0][0] + k * dx,
        LineLocation[0][1] + k * dy,
        LineLocation[0][2] + k * dz,
      ];
      let xx = PointLocation[0] - FootPoint[0];
      let yy = PointLocation[1] - FootPoint[1];
      let zz = PointLocation[2] - FootPoint[2];
      let Distance = Math.sqrt(Math.pow(xx, 2) + Math.pow(yy, 2) + Math.pow(zz, 2));
      return Distance;
    }


    function initobstacle() {
      // 区域越界
      var test = [
        [4, 3, 0],
        [0, 11, 0],
        [-17, 1, 0],
        [-21, 7, 0],
        [5, 22, 0],
        [0, 31, 0],
        [-37, 11, 0],
        [-23, -14, 0],
        [4, 3, 0],
      ];

      // 用户自定义test
      // var test = [
      //   [20, 3, 0],
      //   [26, 4, 0],
      //   [25, 14, 0],
      //   [16, 11, 0],
      //   [20, 3, 0],
      // ];


      // 高程越界
      // let Skytest = [[-6, -6, 20], [6, -6, 18]];
      var area2 = [[-13.2, -20, 28.5], [-24, 28, 28.5]];
      var area3 = [[11.5, 0.2, 0], [11.5, 0.2, 10]];
      var area4 = [[-13.2, -20, 28.5], [-24, 28, 28.5]];
      var area5 = [[-13.2, -20, 5.5], [-24, 28, 5.5]];


      // 区域选择
      function select() {
        $(document).click(function () {
          $(".select_module_con ul").slideUp();
        })
        var module = $(".select_result");
        module.click(function (e) {
          e.stopPropagation();
          var ul = $(this).next();
          ul.stop().slideToggle();
          ul.children().click(function (e) {
            console.log($(this).text()); e.stopPropagation();
            $(this).parent().prev().children("span").text($(this).text());
            ul.stop().slideUp();
            switch ($(this).text()) {
              case "平面不规则区域":
                clearInterval(timer);
                worker_part1.material.color.setHex(0x00FF00);
                worker_part2.material.color.setHex(0x00FF00);
                addWall(test);
                check_dangerous(test, area2, area3, area4, area5, "ground");
                break;
              case "高程区域":
                clearInterval(timer);
                worker_part1.material.color.setHex(0x00FF00);
                worker_part2.material.color.setHex(0x00FF00);
                addSkycheck(new THREE.Vector3(area2[0][0], area2[0][1], area2[0][2]), new THREE.Vector3(area2[1][0], area2[1][1], area2[1][2]), SkyRadius);
                check_dangerous(test, area2, area3, area4, area5, "sky");
                break;
              case "平面区域二":
                clearInterval(timer);
                worker_part1.material.color.setHex(0x00FF00);
                worker_part2.material.color.setHex(0x00FF00);
                var area3_cylinder = createCylinderByTwoPoints(new THREE.Vector3(area3[0][0], area3[0][1], area3[0][2]), new THREE.Vector3(area3[1][0], area3[1][1], area3[1][2]), 1.5);
                scene.add(area3_cylinder);
                check_dangerous(test, area2, area3, area4, area5, "pole");
                break;
              case "集中检测":
                clearInterval(timer);
                worker_part1.material.color.setHex(0x00FF00);
                worker_part2.material.color.setHex(0x00FF00);
                check_dangerous(test, area2, area3, area4, area5, "all");
                break;
              case "高程上":
                addSkycheck(new THREE.Vector3(area4[0][0], area4[0][1], area4[0][2]), new THREE.Vector3(area4[1][0], area4[1][1], area4[1][2]), 1.5);
                break;
              case "高程下":
                clearInterval(timer);
                worker_part1.material.color.setHex(0x00FF00);
                worker_part2.material.color.setHex(0x00FF00);
                addSkycheck(new THREE.Vector3(area5[0][0], area5[0][1], area5[0][2]), new THREE.Vector3(area5[1][0], area5[1][1], area5[1][2]), 1.5);
                check_dangerous(test, area2, area3, area4, area5, "skylow");
                break;
              default:
                break;
            }
          })
        })
      }
      $(function () {
        select();
      })

      // 开始画线
      document.getElementById("BeginShowLine").onclick = function () {
        ifshowline = true;
        document.getElementById("BeginShowLine").style.display = "none";
        document.getElementById("EndShowLine").style.display = "block";
        // var shishipath = [];
        // darwlineTimer = setInterval(() => {
        //   if (ifshowline) {
        //     $.ajax({
        //       type: "GET",
        //       url: "http://124.70.106.8:8080/location/latest/",
        //       success: function (res) {
        //         let newpath = {
        //           x: X_position(res.data[res.data.length - 1].fields.lng),
        //           y: Y_position(res.data[res.data.length - 1].fields.lat),
        //           z: 0,
        //         };
        //         shishipath.push(newpath);
        //         if (shishipath.length == 2) {
        //           ShowLine(
        //             shishipath[0].x,
        //             shishipath[1].x,
        //             shishipath[0].y,
        //             shishipath[1].y,
        //             shishipath[0].z,
        //             shishipath[1].z
        //           );
        //           shishipath.shift();
        //         }
        //       },
        //       error: function (res) {
        //         console.log(res);
        //       },
        //     });
        //   }
        // }, 500);
      }
      // 停止画线
      document.getElementById("EndShowLine").onclick = function () {
        ifshowline = false;
        shishipath = [];
        // clearInterval(darwlineTimer);
        document.getElementById("BeginShowLine").style.display = "block";
        document.getElementById("EndShowLine").style.display = "none";
      }
      // // 关闭警报
      // document.getElementById("closebtn").onclick = function () {
      //   nowarning = true;
      //   document.getElementById("openbtn").style.display = "block";
      //   document.getElementById("closebtn").style.display = "none";
      // }
      // // 打开警报
      // document.getElementById("openbtn").onclick = function () {
      //   nowarning = false;
      //   document.getElementById("openbtn").style.display = "none";
      //   document.getElementById("closebtn").style.display = "block";
      // }

      // 根据用户输入的半径画高程越界区域
      document.getElementById("ConfirmRadius").onclick = function () {
        SkyRadius = document.getElementById("inputradius").value * 2.2;
        addSkycheck(new THREE.Vector3(area2[0][0], area2[0][1], area2[0][2]), new THREE.Vector3(area2[1][0], area2[1][1], area2[1][2]), SkyRadius);
        check_dangerous(test, area2, area3, area4, area5, "sky");
      }
    }


    //窗口变动触发的函数
    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    var spritel;

    function position() {
      scene.remove(spritel);
      let center = worker_part2.position.clone(),
        nameStr = "姓名: name",
        numberStr = "工号: 001",
        zStr = "海拔:" + (center.z.toFixed(3)) / 2.2 + " 米";

      let canvas = document.createElement("canvas");
      canvas.width = 300;
      canvas.height = 400;
      let context = canvas.getContext("2d");
      context.font = "Bold 50px Georgia";
      context.fillStyle = "#ffffff";
      context.fillText(nameStr, 0, 80);
      context.fillText(numberStr, 0, 160);
      context.fillText(zStr, 0, 240);
      let spritelTexture = new THREE.Texture(canvas);
      spritelTexture.needsUpdate = true;
      let spriteMaterial = new THREE.SpriteMaterial({
        map: spritelTexture,
      });
      spritel = new THREE.Sprite(spriteMaterial);
      spritel.scale.set(5, 2.5, 1);
      spritel.position.set(center.x + 3, center.y - 2, center.z + 2);
      scene.add(spritel);
    }

    function animate() {
      //更新控制器
      render();

      controls.update();
      position();
      requestAnimationFrame(animate);
    }

    function draw() {
      init();
      initobstacle();
      animate();
      window.onresize = onWindowResize;
    }
    draw();
  </script>
</body>

</html>